
flows:
 - name: 'c2s'
   proto: udp
   src: 192.168.1.1
   sport: 5050
   dst: 10.1.1.1
   dport: 5060

 - name: 's2c'
   proto: udp
   src: 10.1.1.1
   sport: 5060

 - name: 'c2s_2'
   proto: udp
   intf: eth1
   src: 192.168.1.1
   sport: 5090
   dst: 10.1.1.1
   dport: 5060


scenario: 
 - flow: 'c2s'
   action: 'send'
   type: text
   data: |-
      INVITE sip:7405557000@10.1.1.1:5060;user=phone SIP/2.0
      Via: SIP/2.0/UDP 192.168.1.1:5060;branch=z9hG4bKbe15632f914B3568
      Record-Route: <sip:7405557012@192.168.4.1;lr>
      From: "7012" <sip:7405557012@10.1.1.1:5060>;tag=BA76D475-4FE052EC
      To: <sip:7405557000@10.1.1.1:5060;user=phone>
      Call-ID: 5a2fb8b1-3c6d8673-82af160a@192.168.1.100
      CSeq: 1 INVITE
      Contact: <sip:7405557012@192.168.1.1:7060>
      User-agent: PolycomSoundPointIP-SPIP_501-UA/2.0.2.0076
      Supported: 100rel
      Supported: replaces
      allow-events: talk
      Max-forwards: 70
      Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE, NOTIFY, PRACK, UPDATE, REFER
      Content-Type: application/sdp
      Content-Length:   247

      v=0
      o=- 978385019 978385019 IN IP4 192.168.1.1
      s=Polycom IP Phone
      c=IN IP4 192.168.1.1
      t=0 0
      a=sendrecv
      m=audio 3056 RTP/AVP 0 8 18 101
      a=rtpmap:0 PCMU/8000
      a=rtpmap:8 PCMA/8000
      a=rtpmap:18 G729/8000
      a=rtpmap:101 telephone-event/8000


 - flow: 's2c'
   action: 'recv'
   match: 'INVITE.*SIP/2.0'
   exec:
       - 's2c.dst=IP.src'
       - 's2c.dport=TCP.sport'


 - flow: 's2c'
   action: 'send'
   type: text
   data: |-
        SIP/2.0 200 OK
        Via: SIP/2.0/UDP 10.2.2.2:15060;branch=z9hG4bKbe15632f914B3568
        Record-Route: <sip:7405557012@192.168.4.1;lr>
        From: "7012" <sip:7405557012@10.1.1.1:5060>;tag=BA76D475-4FE052EC
        To: <sip:7405557000@10.1.1.1:5060;user=phone>
        Call-ID: 5a2fb8b1-3c6d8673-82af160a@10.2.2.200
        CSeq: 1 INVITE
        Contact: <sip:7405557012@10.1.1.1:8060>
        Supported: 100rel
        Supported: replaces
        allow-events: talk
        Max-forwards: 70
        Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE,
        NOTIFY, PRACK, UPDATE, REFER
        Content-Type: application/sdp
        Content-Length:   247

        v=0
        o=- 978385019 978385019 IN IP4 10.1.1.1
        s=Polycom IP Phone
        c=IN IP4 10.1.1.1
        t=0 0
        a=sendrecv
        m=audio 8000 RTP/AVP 0 8 18 101
        a=rtpmap:0 PCMU/8000
        a=rtpmap:8 PCMA/8000
        a=rtpmap:18 G729/8000
        a=rtpmap:101 telephone-event/8000


 - action: 'recv'
   flow: 's2c'
        
   match: 'SIP/2.0 200 OK'
   search: 
    - 'Contact:.*<sip:[^@]@(?P<contact_ip>[\d.]):(?P<contact_port>\d+))?'
   exec: 
    - 'c2s_2.dport=contact_port'
    - 'c2s_2.dst=contact_ip


 - flow: 'c2s_2'
   action: 'send'
   type: text
   data: |-
        ACK sip:7405557000@10.1.1.1:5060;user=phone SIP/2.0
        Via: SIP/2.0/UDP 192.168.1.1:5060;branch=z9hG4bKbe15632f914B3568
        Record-Route: <sip:7405557012@192.168.4.1;lr>
        From: "7012" <sip:7405557012@10.1.1.1:5060>;tag=BA76D475-4FE052EC
        To: <sip:7405557000@10.1.1.1:5060;user=phone>
        Call-ID: 5a2fb8b1-3c6d8673-82af160b@192.168.1.100
        CSeq: 1 ACK
        User-agent: PolycomSoundPointIP-SPIP_501-UA/2.0.2.0076
        Supported: 100rel
        Supported: replaces
        Max-forwards: 70
        Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE,
        NOTIFY, PRACK, UPDATE, REFER
        Content-Length: 0


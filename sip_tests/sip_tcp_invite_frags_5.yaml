# Via is split
# Via address is completely in one segment
# Server sends 200 OK to the predicted address
# Confirm that 200 OK is received at the client
 
flows:
 - name: 'c2s'
   proto: tcp
   src: 192.168.1.1
   sport: 5050
   dst: 10.1.1.1
   dport: 5060

 - name: 's2c'
   proto: tcp
   src: 10.1.1.1
   sport: 5060

 - name: 'sip_c2s'
   proto: tcp
   src: 10.1.1.1
   sport: 7060

 - name: 'sip_s2c'
   proto: tcp
   src: 192.168.1.1
   sport: 7060



scenario: 
 - flow: 'c2s'
   action: 'send'
   flags: S

 - flow: 's2c'
   action: 'recv'
   flags: S
   exec:
       - 's2c.dst=IP.src'
       - 's2c.dport=TCP.sport'

 - flow: 's2c'
   action: 'send'
   flags: SA


 - flow: 'c2s'
   action: send
   # space after UDP
   data: |
      INVITE sip:7405557000@10.1.1.1:5060;user=phone SIP/2.0\r\n
      Via: SIP/2.0/UDP 


 - flow: 's2c'
   action: recv
   match: '^INVITE sip:7405557000@'


 - flow: 's2c'
   action: send
   flags: A


 - flow: 'c2s'
   action: send
   data: |-
      {sip_s2c.src}:{sip_s2c.sport};branch=z9hG4bKbe15632f914B3568\r\n
      Record-Route: <sip:7405557012@192.168.4.1;lr>\r\n
      From: "7012" <sip:7405557012@10.1.1.1:5060>;tag=BA76D475-4FE052EC\r\n
      To: <sip:7405557000@10.1.1.1:5060;user=phone>\r\n
      Call-ID: 5a2fb8b1-3c6d8673-82af160a@192.168.1.100\r\n
      CSeq: 1 INVITE\r\n
      Contact: <sip:7405557012@192.168.1.1:7060>\r\n
      User-agent: PolycomSoundPointIP-SPIP_501-UA/2.0.2.0076\r\n
      Supported: 100rel\r\n
      Supported: replaces\r\n
      allow-events: talk\r\n
      Max-forwards: 70\r\n
      Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE, NOTIFY, PRACK, UPDATE, REFER\r\n
      Content-Type: application/sdp\r\n
      Content-Length:   210\r\n
      \r\n
      v=0\r\n
      o=- 978385019 978385019 IN IP4 192.168.1.1\r\n
      s=Polycom IP Phone\r\n
      c=IN IP4 192.168.1.1\r\n
      t=0 0\r\n
      a=sendrecv\r\n
      m=audio 7000 RTP/AVP 0 8 18 101\r\n
      a=rtpmap:0 PCMU/8000\r\n
      a=rtpmap:8 PCMA/8000\r\n
      a=rtpm
      ap:18 G729/8000\r\n


 - flow: 's2c'
   action: recv
   match: '^192.168.1.1:7060;'
   search:
       - '^(?P<via_ip>[\d.]+):(?P<via_port>\d+)'
   exec:
       - 'sip_c2s.dst=via_ip'
       - 'sip_c2s.dport=via_port'


 - flow: 's2c'
   action: send
   flags: A


 - flow: 'sip_c2s'
   action: 'send'
   flags: S

   
 - flow: 'sip_s2c'
   action: 'recv'
   flags: S
   exec:
       - 'sip_s2c.dst=IP.src'
       - 'sip_s2c.dport=TCP.sport'


 - flow: 'sip_s2c'
   action: 'send'
   flags: SA


 - flow: 'sip_c2s'
   action: 'recv'
   flags: SA


 - flow: 'sip_c2s'
   action: send
   flags: A
   data: |-
      SIP/2.0 200 OK\r\n
      From: "7012" <sip:7405557012@10.1.1.1:5060>;tag=BA76D475-4FE052EC\r\n
      To: <sip:7405557000@10.1.1.1:5060;user=phone>\r\n
      Call-ID: 5a2fb8b1-3c6d8673-82af160a@192.168.1.100\r\n
      CSeq: 1 INVITE\r\n
      Contact: <sip:7405557012@10.1.1.1:7060>\r\n
      User-agent: PolycomSoundPointIP-SPIP_501-UA/2.0.2.0076\r\n
      Supported: 100rel\r\n
      allow-events: talk\r\n
      Max-forwards: 70\r\n
      Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, INFO, MESSAGE, SUBSCRIBE, NOTIFY, PRACK, UPDATE, REFER\r\n
      Content-Type: application/sdp\r\n
      Content-Length: 0\r\n
      \r\n

 - flow: sip_s2c
   action: recv
   match: 'SIP/2.0 200 OK'
